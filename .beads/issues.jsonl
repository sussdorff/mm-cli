{"id":"mm-cli-bee","title":"Expose additional MoneyMoney AppleScript functionality","description":"## Overview\nMoneyMoney provides extensive AppleScript automation beyond basic data retrieval. This ticket covers exposing all additional capabilities through the CLI.\n\n## Reference\nOfficial documentation: https://moneymoney.app/applescript/\n\n## Additional Commands to Implement\n\n### Portfolio Management\n#### `mm portfolio`\nExport securities holdings.\n- AppleScript: `export portfolio from account ... as \"plist\"`\n- Options:\n  - `--account` / `-a`: Specific account (optional, all if omitted)\n- Output: Security name, ISIN, quantity, value, performance\n\n### Bank Transfers\n#### `mm transfer`\nCreate a bank transfer.\n- AppleScript: `create bank transfer from account ... to ... iban ... amount ... purpose ...`\n- Arguments:\n  - `--from-account`: Source account\n  - `--to`: Recipient name\n  - `--iban`: Recipient IBAN\n  - `--amount`: Transfer amount\n  - `--purpose`: Transfer purpose/reference\n- Options:\n  - `--outbox`: Save to outbox without opening UI\n  - `--dry-run`: Show transfer details without creating\n\n#### `mm batch-transfer`\nImport SEPA-XML batch transfer.\n- AppleScript: `create batch transfer from POSIX file ...`\n- Arguments:\n  - `file`: Path to SEPA-XML file\n- Options:\n  - `--validate`: Validate XML without importing\n\n### Direct Debits\n#### `mm direct-debit`\nCreate a direct debit.\n- AppleScript: `create direct debit from account ... for ... iban ... amount ... purpose ... mandate reference ... mandate date ... scheduled date ...`\n- Arguments:\n  - `--from-account`: Creditor account\n  - `--for`: Debtor name\n  - `--iban`: Debtor IBAN\n  - `--amount`: Debit amount\n  - `--purpose`: Purpose text\n  - `--mandate-ref`: SEPA mandate reference\n  - `--mandate-date`: Mandate signature date (YYYY-MM-DD)\n  - `--scheduled-date`: Execution date (YYYY-MM-DD)\n- Options:\n  - `--outbox`: Save to outbox without opening UI\n\n#### `mm batch-direct-debit`\nImport SEPA-XML batch direct debit.\n- AppleScript: `create batch direct debit from POSIX file ...`\n- Arguments:\n  - `file`: Path to SEPA-XML file\n\n### Offline Account Management\n#### `mm add-transaction`\nAdd transaction to offline account.\n- AppleScript: `add transaction to account ... on date ... to ... amount ... purpose ... category ...`\n- Arguments:\n  - `--account`: Target offline account name\n  - `--date`: Transaction date (YYYY-MM-DD)\n  - `--to`: Payee/recipient name\n  - `--amount`: Transaction amount (negative for expenses)\n  - `--purpose`: Description/purpose\n  - `--category`: Category name (optional)\n\n### Transaction Management\n#### `mm set-checkmark`\nSet/unset transaction checkmark.\n- AppleScript: `set transaction id [ID] checkmark to \"on\"/\"off\"`\n- Arguments:\n  - `transaction_id`: Transaction ID\n  - `state`: on/off\n\n#### `mm set-comment`\nAdd/update transaction note.\n- AppleScript: `set transaction id [ID] comment to ...`\n- Arguments:\n  - `transaction_id`: Transaction ID\n  - `comment`: Note text\n\n### Export Enhancements\n#### `mm export`\nUnified export command with format options.\n- Subcommands:\n  - `mm export transactions --format csv/plist/json`\n  - `mm export accounts --format plist/json`\n  - `mm export categories --format plist/json`\n  - `mm export portfolio --format plist/json`\n\n## Implementation Notes\n\n### Safety Considerations\n- Transfer and direct debit commands should require `--confirm` flag or interactive confirmation\n- Add `--dry-run` to all write operations\n- Validate IBAN format before sending to AppleScript\n- Validate dates and amounts\n\n### Command Groups\nOrganize commands into logical groups:\n- `mm accounts` - Account operations\n- `mm transactions` - Transaction queries\n- `mm categories` - Category management\n- `mm transfers` - Transfer operations (transfer, batch-transfer)\n- `mm debits` - Direct debit operations (direct-debit, batch-direct-debit)\n- `mm portfolio` - Securities/portfolio\n\n## Acceptance Criteria\n- [ ] All additional AppleScript commands exposed via CLI\n- [ ] Safety confirmations for write operations\n- [ ] IBAN validation\n- [ ] Date format validation\n- [ ] SEPA-XML validation for batch imports\n- [ ] Comprehensive --help for all commands\n- [ ] Integration tests with MoneyMoney (manual verification)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:45.22783+01:00","created_by":"malte","updated_at":"2026-01-06T14:04:45.22783+01:00","dependencies":[{"issue_id":"mm-cli-bee","depends_on_id":"mm-cli-ezy","type":"blocks","created_at":"2026-01-06T14:04:45.23055+01:00","created_by":"malte"}]}
{"id":"mm-cli-dyg","title":"Fix category hierarchy - categories export is flat, losing parent-child structure","description":"## Problem\nThe mm categories command returns all 106 categories as flat/root-level items with no parent information. MoneyMoney's export categories AppleScript returns a flat plist. However, transaction data contains full category paths with backslash separators (e.g. Malte\\Ausgaben\\Leben\\Ernährung), proving the hierarchy exists.\n\n## Root Cause  \nMoneyMoney's export categories plist has no children arrays. The _parse_category_tree() in applescript.py:228 handles children but there are none.\n\n## Solution\nReconstruct hierarchy from transaction category paths. Export transactions, collect unique category paths, build tree from backslash-separated paths. Map category UUIDs via categoryUuid field.\n\n## Impact\n- 106 categories shown flat with no hierarchy\n- Duplicate names (3x Sonstiges, 3x Nebenkosten, 2x Ausgaben) are indistinguishable\n- Cannot suggest proper categories for uncategorized transactions","status":"closed","priority":1,"issue_type":"bug","owner":"malte.sussdorff@cognovis.de","created_at":"2026-01-26T13:53:18.093472+01:00","created_by":"Malte Sussdorff","updated_at":"2026-01-26T14:01:09.47752+01:00","closed_at":"2026-01-26T14:01:09.47752+01:00","close_reason":"Closed"}
{"id":"mm-cli-ezy","title":"Implement core CLI commands for MoneyMoney interaction","description":"## Overview\nImplement the core CLI commands to interact with MoneyMoney macOS app via AppleScript. This is the foundation for all MoneyMoney data access.\n\n## Commands to Implement\n\n### 1. `mm accounts`\nList all accounts from MoneyMoney database.\n- AppleScript: `export accounts`\n- Returns: Account ID, name, balance, type, bank name\n- Output formats: table (default), json\n\n### 2. `mm transactions`\nList transactions with filtering options.\n- AppleScript: `export transactions from account ... from date ... to date ... as \"plist\"`\n- Options:\n  - `--account` / `-a`: Filter by account ID or name\n  - `--from` / `-f`: Start date (YYYY-MM-DD)\n  - `--to` / `-t`: End date (YYYY-MM-DD)  \n  - `--category` / `-c`: Filter by category\n  - `--uncategorized`: Show only uncategorized transactions\n- Output formats: table (default), json, csv\n\n### 3. `mm categories`\nList all categories from MoneyMoney.\n- AppleScript: `export categories`\n- Returns: Category UUID, name, parent category, type (income/expense)\n- Output formats: table (default), json\n\n### 4. `mm category-usage`\nShow categories sorted by transaction count.\n- Requires: transactions export + category mapping\n- Output: Category name, transaction count, total amount\n- Options:\n  - `--from` / `-f`: Start date\n  - `--to` / `-t`: End date\n  - `--limit` / `-n`: Top N categories\n\n### 5. `mm set-category`\nUpdate the category of a transaction.\n- AppleScript: `set transaction id [ID] category to [UUID]`\n- Arguments:\n  - `transaction_id`: Transaction ID (from plist export)\n  - `category`: Category name or UUID\n- Options:\n  - `--dry-run`: Show what would be changed without applying\n\n## Technical Implementation\n\n### AppleScript Module (`mm_cli/applescript.py`)\n- `run_applescript(script: str) -\u003e str`: Execute AppleScript via osascript\n- `export_accounts() -\u003e list[dict]`: Get all accounts\n- `export_transactions(...) -\u003e list[dict]`: Get transactions with filters\n- `export_categories() -\u003e list[dict]`: Get all categories\n- `set_transaction_category(tx_id: str, category_id: str) -\u003e bool`: Update category\n\n### Models (`mm_cli/models.py`)\n- `Account`: dataclass for account data\n- `Transaction`: dataclass for transaction data\n- `Category`: dataclass for category data\n\n### Output Formatting (`mm_cli/output.py`)\n- Rich tables for terminal output\n- JSON serialization\n- CSV export\n\n## Acceptance Criteria\n- [ ] All 5 commands implemented and working\n- [ ] Proper error handling for AppleScript failures\n- [ ] Rich formatted tables for human-readable output\n- [ ] JSON output option for machine processing\n- [ ] Unit tests with mocked AppleScript responses\n- [ ] `--help` documentation for all commands","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:04:05.745845+01:00","created_by":"malte","updated_at":"2026-01-06T14:14:32.841262+01:00","closed_at":"2026-01-06T14:14:32.841262+01:00","close_reason":"All 5 CLI commands implemented with full test coverage"}
{"id":"mm-cli-obm","title":"Add account groups/hierarchy to accounts command","description":"## Problem\nmm accounts skips account groups (applescript.py:190). MoneyMoney organizes accounts into groups (Haushalt, Privat, cognovis, Aufgelöst, FlyHH) but this structure is lost.\n\n## Requirements\n- Show account groups in table output (indented or grouped)\n- Add --include-groups or --show-groups flag  \n- Add --active flag to filter out zero-balance/closed accounts (Aufgelöst group)\n- JSON output should include group name as field\n- Consider --group filter flag\n\n## Known Groups\nHaushalt: DKB Haushalt\nPrivat: Haus, Tagesgeld, Privat, Flatex, AMEX Malte, MLP Kreditkarte\ncognovis: Postbank, Fyrst Base, CapTrader, AMEX Business Gold, PayPal\nAufgelöst: Penta, Smartbroker, old cards\nFlyHH: Fidor, old Postbank, old cards, AirBnB, Instandhaltung","status":"open","priority":2,"issue_type":"task","owner":"malte.sussdorff@cognovis.de","created_at":"2026-01-26T13:53:24.1056+01:00","created_by":"Malte Sussdorff","updated_at":"2026-01-26T13:53:24.1056+01:00"}
{"id":"mm-cli-wk8","title":"Add suggest-rules command for MoneyMoney auto-categorization analysis","description":"## Context\nMoneyMoney has NO AppleScript API for reading or managing rules as separate entities (confirmed via .sdef scripting dictionary). HOWEVER, the export categories plist DOES include a 'rules' field on each category containing the MoneyMoney rule text. This is now parsed and available in mm-cli via the Category.rules field.\n\n## What's Already Available (after mm-cli-dyg fix)\n- Category.rules: The MoneyMoney rule text for each category\n- Category.path: Full hierarchical path (e.g. Malte\\Ausgaben\\Leben\\Ernährung)\n- Category.indentation: Nesting level\n- Category.group: Whether it's a group/folder\n- mm categories --format json: Full data including rules\n\n## Feature: mm suggest-rules\nAnalyze transaction data to suggest NEW MoneyMoney rules:\n1. Find uncategorized transactions, match against patterns from categorized ones\n2. Suggest rules based on recurring payee patterns\n3. Compare against existing rules to avoid duplicates\n4. Detect PayPal + direct merchant duplicates (same amount, same date)\n\n## Output Example\nPattern                        | Category      | Matches | Existing Rule?\nName contains Apple.com.Bill   | Subscriptions | 4       | Partial (Apple.com/Bill in Sonstige Unterhaltung)\nName contains Versicherung     | Versicherung  | 4       | No\n\n## Implementation\n- Use export_transactions() for transaction data\n- Use export_categories() for existing rules\n- Build payee-\u003ecategory mapping from categorized transactions\n- Compare suggested rules against existing Category.rules\n- Apply fuzzy matching (normalize PayPal names, strip location suffixes)\n- Use historical data for better matching","status":"closed","priority":2,"issue_type":"feature","owner":"malte.sussdorff@cognovis.de","created_at":"2026-01-26T13:53:30.084484+01:00","created_by":"Malte Sussdorff","updated_at":"2026-01-26T14:09:51.107943+01:00","closed_at":"2026-01-26T14:09:51.107943+01:00","close_reason":"Closed","dependencies":[{"issue_id":"mm-cli-wk8","depends_on_id":"mm-cli-dyg","type":"blocks","created_at":"2026-01-26T13:54:06.612269+01:00","created_by":"Malte Sussdorff"}]}
